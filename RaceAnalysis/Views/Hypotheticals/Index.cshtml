@model RaceAnalysis.Models.HypotheticalsViewModel

@{
    Layout = "~/Views/Layouts/_Layout.cshtml";
}

@section scripts {
<script type="text/javascript" src="https://cdn.plot.ly/plotly-latest.min.js"></script>
}

<form id="myForm">
    <div id="Criteria">

        I am interested in this race:
        @Html.ListBoxFor(m => m.Filter.SelectedRaceIds,
                      new SelectList(Model.Filter.AvailableRaces, "RaceId", "DisplayName"),
                      new { @id = "raceSelectId" })

        I am a @Html.ListBoxFor(m => m.Filter.SelectedGenderIds,
                new SelectList(Model.Filter.AvailableGenders, "GenderId", "DisplayName"),
                new { @id = "genderSelectId" }), in this age group: @Html.ListBoxFor(m => m.Filter.SelectedAgeGroupIds,
                new SelectList(Model.Filter.AvailableAgeGroups, "AgeGroupId", "DisplayName"),
                new { @id = "agSelectId" })

                @Html.ListBoxFor(m => m.SelectedSkillLevel,
                new SelectList(Model.AvailableSkillLevels, "Value", "DisplayName"),
                new { @id = "skillLevelId" })

            </div>
 </form>
<div class="hypothetical">
    @Ajax.ActionLink("What is my expected finish time?",
                        "FinishTime", "Hypotheticals",
                        null,
                        new AjaxOptions
                        {
                            UpdateTargetId = "ExpectedFinishTimeResults",
                            InsertionMode = InsertionMode.Replace,
                            HttpMethod = "GET",
                            OnBegin = "beginPost"
                        },
                        htmlAttributes: new { id = "ExpectedFinishTime" })
</div>
 
<div id="ExpectedFinishTimeResults"></div>

<div>
     

    <div class="hypothetical">
        If I biked[Select Bike Duration], how would I do?  Action: [Find Out..]
    </div>

        Results:
        X% of athletes that had a bike time of[XXX]:
        Ran: [XXX Time]
        Finished: [XXXX Time]

    <div class="hypothetical">
        If I swam[Select Swim Duration], how would I fare against other athletes?
        [Box model with annotation]
    </div>



    <script type="text/javascript">

    $(document).ready(function () {

        var $race_select = $("#raceSelectId").select2({
            placeholder: "Select Races...",
            width: '95%',
            theme: "bootstrap",
            maximumSelectionLength: 1
        });
        var $ag_select = $("#agSelectId").select2({
            placeholder: "My Age Group...",
            width: '95%',
            theme: "bootstrap",
            maximumSelectionLength: 1
        });
        var $gen_select = $("#genderSelectId").select2({
            placeholder: "My Gender...",
            width: '95%',
            theme: "bootstrap",
            maximumSelectionLength: 1
        });

        var $skill_select = $("#skillLevelId").select2({
            placeholder: "Skill level...",
            width: '95%',
            theme: "bootstrap",
            maximumSelectionLength: 1
        });



        $('#myForm').validate({
            ignore: 'input[type=hidden], .select2-input, .select2-focusser',
            errorElement: "div",
            errorPlacement: function (error, element) {
                element.after(error);
            }
        });
        /*
    * When you change the value the select via select2, it triggers
    * a 'change' event, but the jquery validation plugin
    * only re-validates on 'blur'
    */
        $race_select.on('change', function () {
            $(this).trigger('blur');
        });
        $ag_select.on('change', function () {
            $(this).trigger('blur');
        });
        $gen_select.on('change', function () {
            $(this).trigger('blur');
        });
        $skill_select.on('change', function () {
            $(this).trigger('blur');
        });

        $race_select.rules('add', 'required');
        $ag_select.rules('add', 'required');
        $gen_select.rules('add', 'required');
        $skill_select.rules('add', 'required');

    }());

    function beginPost(xhr, request) {
        var requester = $(this);
        //if (!validateForm(requester))/*TBD, validation  is not working*/
           // return false;

        var race = $("#raceSelectId").val();
        var ag = $("#agSelectId").val();
        var gender = $("#genderSelectId").val();
        var skill = $("#skillLevelId").val();
            
        if (race.length == 0 || ag.length == 0 || gender.length == 0 || skill.length == 0)//poor man's validation
            return false;

        var requestParams = request.url.split('?');
        request.url = requestParams[0] + "?races=" + race + "&agegroups=" + ag + "&genders=" + gender + "&skilllevel=" + skill;
    }
    function validateForm(requester)
    {
        var _form = requester.closest("form");
        var validator = $('#myForm').validate({
            ignore: 'input[type=hidden], .select2-input, .select2-focusser',
            errorElement: "div",
            errorPlacement: function (error, element) {
                element.after(error);
            }
        });
        //var validator = $("#myForm").validate(); // obtain validator
        var anyError = false;
     

        if (anyError)
            return false; // exit if any error found    

    }

 </script>

